<div class="mis-turnos-paciente">
  <h2>Mis Turnos</h2>

  <!-- Filtro único -->
  <div class="filtro-turnos">
    <label>Filtrar por:</label>
    <button [class.active]="filtroTipo === 'especialidad'" (click)="setFiltroTipo('especialidad')">Especialidad</button>
    <button [class.active]="filtroTipo === 'especialista'" (click)="setFiltroTipo('especialista')">Especialista</button>
    <input type="text" [(ngModel)]="filtro" (input)="filtrarTurnos()" placeholder="Buscar..." />
  </div>

  <div *ngIf="mensaje" class="mensaje" (click)="limpiarMensaje()">{{ mensaje }}</div>

  <div *ngIf="turnosFiltrados.length === 0" class="sin-turnos">No tienes turnos para mostrar.</div>

  <div class="turnos-lista">
    <div *ngFor="let turno of turnosFiltrados" class="turno-item" @turnoAnim>
      <div class="turno-info">
        <div><strong>Especialidad:</strong> {{ turno.especialidad }}</div>
        <div><strong>Especialista:</strong> {{ turno.especialistaNombre }}</div>
        <div><strong>Fecha:</strong> {{ turno.fecha | date:'short' }}</div>
        <div><strong>Estado:</strong> <span class="estado estado-{{ turno.estado }}">{{ estadoTurno(turno) }}</span></div>
      </div>

      <!-- Acciones -->
      <div class="turno-acciones">
        <!-- Cancelar turno -->
        <button *ngIf="puedeCancelar(turno)" (click)="mostrarDialogoCancelacion(turno.id)">Cancelar</button>
        <!-- Ver reseña -->
        <button *ngIf="puedeVerResena(turno)" (click)="mensaje = turno.resena || ''">Ver Reseña</button>
        <!-- Completar encuesta -->
        <button *ngIf="puedeCompletarEncuesta(turno)" (click)="completarEncuesta(turno)">Completar Encuesta</button>
        <!-- Calificar atención -->
        <button *ngIf="puedeCalificar(turno)" (click)="mostrarDialogoCalificacion(turno.id)">Calificar Atención</button>
      </div>

      <!-- Diálogo cancelar turno -->
      <div *ngIf="mostrarComentarioCancelacion === turno.id" class="dialogo">
        <label>¿Por qué cancelas el turno?</label>
        <textarea [(ngModel)]="comentarioCancelacion" rows="2"></textarea>
        <button (click)="cancelarTurno(turno)">Confirmar Cancelación</button>
        <button (click)="mostrarComentarioCancelacion = null">Cerrar</button>
      </div>

      <!-- Diálogo calificar atención -->
      <div *ngIf="mostrarCalificacion === turno.id" class="dialogo">
        <label>Califica la atención del especialista:</label>
        <select [(ngModel)]="calificacionPuntaje">
          <option *ngFor="let n of [1,2,3,4,5]" [value]="n">{{ n }} ⭐</option>
        </select>
        <textarea [(ngModel)]="calificacionComentario" placeholder="Comentario"></textarea>
        <button (click)="calificarAtencion(turno)">Enviar Calificación</button>
        <button (click)="mostrarCalificacion = null">Cerrar</button>
      </div>
    </div>
  </div>
</div>
